/include/ "system-conf.dtsi"
/ {
	chosen {
		bootargs = "console=ttyPS0,115200 root=/dev/mmcblk0p2 rw rootwait uio_pdrv_genirq.of_id=generic-uio ip=192.168.100.1::192.168.1.1:255.255.255.0:petalinux:enx000a35001e53:off";
        /* bootargs = "console=ttyPS0,115200 root=/dev/mmcblk0p2 rw earlyprintk rootfstype=ext4 rootwait devtmpfs.mount=1 uio_pdrv_genirq.of_id=generic-uio"; */
		stdout-path = "serial0:115200n8";
	};

	memory@0 {
		device_type = "memory";
		reg = <0x0 0x40000000>; /* 1GB total memory */
	};

	/* Reserve 32MB for DMA operations */
	reserved-memory {
		#address-cells = <1>;
		#size-cells = <1>;
		ranges;

		dma_reserved: dma-memory@1e000000 {
			compatible = "shared-dma-pool";
			reg = <0x1e000000 0x2000000>; /* 32MB at 512MB offset */
			no-map;
		};
	};

	/* Aliases for easy identification */  
	aliases {
		uio0 = &axi_dma_0;
		uio1 = &axi_lite_control_0;
		uio2 = &axi_lite_control_0;
	};
};

/* Override the auto-generated AXI DMA to use UIO instead of native driver */
&axi_dma_0 {
	compatible = "generic-uio"; // pl.dtsi has "simple-bus"
	/* Keep the existing reg, interrupts, and other properties from pl.dtsi */
	/* Add memory region for DMA operations */
	memory-region = <&dma_reserved>;
	// interrupts = <0 61 4>; /* S2MM interrupt - IRQ_F2P[0] = SPI 61. PL is setting this to 29 for some reason?!!? */
	status = "okay";
};

/* Override the auto-generated AXI Lite Control to use UIO */
&axi_lite_control_0 {
	compatible = "generic-uio"; // pl.dtsi has "xlnx,axi-lite-control-1.0";
	/* Keep the existing reg and other properties from pl.dtsi */
	status = "okay";
	/* Add interrupt if your control registers generate interrupts */
	/* interrupt-parent = <&intc>; */
	/* interrupts = <0 62 4>; */ /* IRQ_F2P[1] if needed */
	/* interrupt-names = "control_irq"; */
};

/* Override the auto-generated AXI Lite Status to use UIO */
&axi_lite_status_0 {
	compatible = "generic-uio";
	/* Keep the existing reg and other properties from pl.dtsi */
	status = "okay";
};



/* Alternative configuration using xlnx,axi-dma if you prefer native driver support */
/*
&amba_pl {
	axi_dma_0: dma@40400000 {
		compatible = "xlnx,axi-dma-1.00.a";
		reg = <0x40400000 0x10000>;
		#dma-cells = <1>;
		interrupt-parent = <&intc>;
		interrupts = <0 61 4>;
		memory-region = <&dma_reserved>;
		xlnx,addrwidth = <0x20>;
		xlnx,sg-length-width = <0x17>;
		xlnx,include-sg;
		xlnx,sg-include-stscntrl-strm = <0x0>;
		
		// S2MM channel only (MM2S disabled)
		dma-channel@40400030 {
			compatible = "xlnx,axi-dma-s2mm-channel";
			interrupts = <0 29 4>;
			xlnx,datawidth = <0x20>; // Adjust based on your data width
			xlnx,device-id = <0x0>;
		};
	};
};
*/